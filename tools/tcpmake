#! /bin/ksh

# @(#) $Id: tcpmake,v 1.33 1996-08-12 18:52:58 deyke Exp $

save_file()
{
	if [[ -f $1 ]]; then
		cp -p $1 $1.old
	fi
}

check_file()
{
	if [[ -f $1.old ]]; then
		if cmp -s $1.old $1; then
			mv $1.old $1
		else
			rm $1.old
		fi
	fi
}

date=$(date +%y%m%d)

if [[ -x /bin/hp9000s700 ]] && /bin/hp9000s700; then
	export CCOPTS='-z +ESlit'
fi

cd ~/tcp/lib
file=configure.h
save_file $file
ksh < configure > configure.h
check_file $file

cd ~/tcp/hostfiles
trimfiles

cd ~/tcp

file=hosts
save_file $file
cd hostfiles
include < hosts > ../$file
cd ..
check_file $file

file=README
save_file $file
sed "s/wampes-....../wampes-$date/g" < $file.old > $file
check_file $file

cd ~/tcp/src
file=version.c
save_file $file
sed "s/WAMPES-....../WAMPES-$date/g" < $file.old > $file
check_file $file

for dir in \
	~/tcp \
	~/tcp/aos \
	~/tcp/bbs \
	~/tcp/convers \
	~/tcp/doc \
	~/tcp/examples \
	~/tcp/lib \
	~/tcp/src \
	~/tcp/tools \
	~/tcp/util \
	; do
	cd $dir
	for file in Makefile*; do
		if [[ -f $file ]]; then
			save_file $file
			make -f $file depend
			check_file $file
		fi
	done
	for file in *.[ch]; do
		if [[ -f $file && $file != configure.h ]]; then
			case $(grep -F -c '@(#) $Id' $file) in
			0)
				save_file $file
				echo '/* @(#) $Id\c' > $file
				echo '$ */\n' >> $file
				cat $file.old >> $file
				check_file $file
				echo RCS header inserted in $file
				;;
			1)
				;;
			*)
				echo $file has too many RCS headers
				;;
			esac
		fi
	done
	trimfiles
done

cd ~/tcp
make
mk make

cd ~/tcp/src
make lint tags TAGS 
nosdiff
# jnosdiff -w

cd ~/tcp/manuals
for manual in bbs bridge netupd smack wampes; do
	cd ~/tcp/manuals/$manual

	file=frontpage
	save_file $file
	sed "s/Version [0-9][0-9][0-9][0-9][0-9][0-9]/Version $date/g" < $file.old > $file
	check_file $file

	file=../../doc/$manual.mm
	save_file $file
	cat $(< filelist) | grep -v '@(#) $Id' > $file
	check_file $file

done

cd ~/tcp/doc
for file in *.gif; do
	save_file $file
done
for manual in bbs bridge netupd smack wampes; do
	file=$manual.html
	save_file $file
	mm2html $manual.mm > $file
	check_file $file
done
for file in *.gif; do
	check_file $file
done

cd ~/tcp/bbs
file=bbs.help
save_file $file
groff -p -t -mgm -Tascii < ~/tcp/doc/bbs.mm | sed 's/.//g' | awk '
	/BBS Reference Manual.*Version/ {
		next
	}
	/^ *CONTENTS *$/ {
		exit
	}
	/^[0-9][0-9]*\.[0-9]* \ / {
		print ""
		print "^" $2
		print ""
		sub("^[0-9][0-9]*\.[0-9]* \ ", "")
		print
		next
	}
	{
		print
	}
' | trim -s | expand > $file
check_file $file
mk make install

echo '***** tcpmake complete *****'
