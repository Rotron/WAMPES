#! /bin/ksh

# @(#) $Header: /home/deyke/tmp/cvs/tcp/tools/tcpmake,v 1.18 1994-11-28 10:39:50 deyke Exp $

save_file()
{
	if [[ -f $1 ]]; then
		cp -p $1 $1.old
	fi
}

check_file()
{
	if [[ -f $1.old ]]; then
		if cmp -s $1.old $1; then
			mv $1.old $1
		else
			rm $1.old
		fi
	fi
}

date=$(date +%y%m%d)

if [[ -x /bin/hp9000s700 ]] && /bin/hp9000s700; then
	export CCOPTS='-z +ESlit'
fi

cd ~/tcp/lib
ksh < configure > configure.h

cd ~/tcp

file=hosts
save_file $file
cat hostfiles/* > $file
check_file $file

file=README
save_file $file
sed "s/wampes-....../wampes-$date/g" < $file.old > $file
check_file $file

cd ~/tcp/src
file=version.c
save_file $file
sed "s/WAMPES-....../WAMPES-$date/g" < $file.old > $file
check_file $file

for dir in \
	~/tcp \
	~/tcp/aos \
	~/tcp/bbs \
	~/tcp/convers \
	~/tcp/doc \
	~/tcp/examples \
	~/tcp/lib \
	~/tcp/src \
	~/tcp/tools \
	~/tcp/util \
	; do
	cd $dir
	for file in Makefile*; do
		if [[ -f $file ]]; then
			save_file $file
			make -f $file depend
			check_file $file
		fi
	done
	for file in *.[ch]; do
		if [[ -f $file ]]; then
			case $(grep -F -c '@(#) $Header' $file) in
			0)
				save_file $file
				echo '/* @(#) $Header\c' > $file
				echo '$ */\n' >> $file
				cat $file.old >> $file
				check_file $file
				echo RCS header inserted in $file
				;;
			1)
				;;
			*)
				echo $file has too many RCS headers
				;;
			esac
		fi
	done
	trimfiles
done

cd ~/tcp
make
mk make

cd ~/tcp/tools
make

cd ~/tcp/src
make lint tags
nosdiff
jnosdiff -w

cd ~/tcp/manuals
for manual in *; do
	cd ~/tcp/manuals/$manual

	file=frontpage
	save_file $file
	sed "s/Version ....../Version $date/g" < $file.old > $file
	check_file $file

	file=../../doc/$manual.mm
	save_file $file
	cat $(< filelist) | grep -v '@(#) $Header' > $file
	check_file $file

done

cd ~/tcp/doc
for manual in *.mm; do
	manual=${manual%.mm}
	file=$manual.html
	save_file $file
	mm2html $manual.mm > $file
	check_file $file
done

echo '***** tcpmake complete *****'
